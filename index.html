<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Masjid Patisah</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode/1.5.3/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: white;
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        .subtitle {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2em;
            font-style: italic;
        }

        .nav-tabs {
            display: flex;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .nav-tab {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 15px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .nav-tab:hover, .nav-tab.active {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .content-section {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .content-section.active {
            display: block;
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .info-card {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .qr-section {
            text-align: center;
            margin: 20px 0;
        }

        .qr-controls {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        input, select {
            width: 100%;
            max-width: 300px;
            padding: 12px 15px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            margin: 10px 0;
            transition: border-color 0.3s ease;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        #qrcode, #scanned-qr {
            margin: 20px auto;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            display: inline-block;
        }

        #video-container {
            position: relative;
            max-width: 400px;
            margin: 20px auto;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        video {
            width: 100%;
            height: auto;
        }

        .attendance-list {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
        }

        .attendance-item {
            background: rgba(255, 255, 255, 0.2);
            margin: 10px 0;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .schedule-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        .schedule-table th, .schedule-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        .schedule-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .mosque-image {
            width: 100%;
            max-width: 600px;
            height: 300px;
            object-fit: cover;
            border-radius: 15px;
            margin: 20px auto;
            display: block;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            h1 {
                font-size: 2em;
            }
            
            .nav-tabs {
                flex-direction: column;
                align-items: center;
            }
            
            .qr-controls {
                flex-direction: column;
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üïå Masjid Patisah</h1>
            <p class="subtitle">Masjid yang Berkah, Jamaah yang Terkah</p>
        </header>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="showSection('home')">Beranda</button>
            <button class="nav-tab" onclick="showSection('schedule')">Jadwal</button>
            <button class="nav-tab" onclick="showSection('qr-generator')">Generate QR</button>
            <button class="nav-tab" onclick="showSection('qr-scanner')">Scan QR</button>
            <button class="nav-tab" onclick="showSection('attendance')">Presensi</button>
        </div>

        <!-- Beranda Section -->
        <div id="home" class="content-section active">
            <h2>Selamat Datang di Masjid Patisah</h2>
            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='600' height='300' viewBox='0 0 600 300'%3E%3Crect width='600' height='300' fill='%234a90e2'/%3E%3Cpath d='M300 50 L350 100 L250 100 Z' fill='%23f39c12'/%3E%3Crect x='280' y='100' width='40' height='80' fill='%23e74c3c'/%3E%3Cpath d='M200 150 Q300 100 400 150' stroke='%23f39c12' stroke-width='3' fill='none'/%3E%3Ccircle cx='150' cy='180' r='20' fill='%23f39c12'/%3E%3Ccircle cx='450' cy='180' r='20' fill='%23f39c12'/%3E%3Ctext x='300' y='250' text-anchor='middle' fill='white' font-size='24' font-weight='bold'%3EMasjid Patisah%3C/text%3E%3C/svg%3E" alt="Masjid Patisah" class="mosque-image">
            
            <div class="info-grid">
                <div class="info-card">
                    <h3>üìç Alamat</h3>
                    <p>Jl. Patisah No. 123<br>Surakarta, Jawa Tengah</p>
                </div>
                <div class="info-card">
                    <h3>üë®‚Äçüíº Takmir</h3>
                    <p>Ustadz Ahmad Fauzi, S.Ag<br>HP: 0812-3456-7890</p>
                </div>
                <div class="info-card">
                    <h3>üèóÔ∏è Didirikan</h3>
                    <p>Tahun 1985<br>Renovasi terakhir: 2020</p>
                </div>
                <div class="info-card">
                    <h3>üë• Kapasitas</h3>
                    <p>500 Jamaah<br>Parkir: 100 kendaraan</p>
                </div>
            </div>

            <h3 style="margin-top: 30px;">Tentang Masjid Patisah</h3>
            <p>Masjid Patisah adalah masjid bersejarah yang telah melayani masyarakat Surakarta selama lebih dari 35 tahun. Dengan arsitektur yang memadukan gaya tradisional Jawa dan modern, masjid ini menjadi pusat kegiatan keagamaan dan sosial bagi warga sekitar.</p>
            
            <p>Masjid ini dilengkapi dengan fasilitas modern termasuk sistem sound yang baik, AC, tempat wudhu yang bersih, dan area parkir yang luas. Setiap hari, ratusan jamaah datang untuk melaksanakan sholat berjamaah dan mengikuti berbagai kegiatan keagamaan.</p>
        </div>

        <!-- Schedule Section -->
        <div id="schedule" class="content-section">
            <h2>Jadwal Kegiatan Masjid</h2>
            
            <table class="schedule-table">
                <thead>
                    <tr>
                        <th>Waktu</th>
                        <th>Kegiatan</th>
                        <th>Hari</th>
                        <th>Keterangan</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>04:30 - 05:30</td>
                        <td>Sholat Subuh Berjamaah</td>
                        <td>Setiap Hari</td>
                        <td>Dilanjut kultum</td>
                    </tr>
                    <tr>
                        <td>12:00 - 12:30</td>
                        <td>Sholat Dzuhur Berjamaah</td>
                        <td>Setiap Hari</td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>15:30 - 16:00</td>
                        <td>Sholat Ashar Berjamaah</td>
                        <td>Setiap Hari</td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>18:00 - 18:30</td>
                        <td>Sholat Maghrib Berjamaah</td>
                        <td>Setiap Hari</td>
                        <td>Dilanjut pengajian</td>
                    </tr>
                    <tr>
                        <td>19:00 - 19:30</td>
                        <td>Sholat Isya Berjamaah</td>
                        <td>Setiap Hari</td>
                        <td>-</td>
                    </tr>
                    <tr>
                        <td>20:00 - 21:00</td>
                        <td>Pengajian Umum</td>
                        <td>Senin, Rabu, Jumat</td>
                        <td>Ustadz Ahmad Fauzi</td>
                    </tr>
                    <tr>
                        <td>08:00 - 09:00</td>
                        <td>Pengajian Ibu-ibu</td>
                        <td>Kamis</td>
                        <td>Ustadzah Siti Aisyah</td>
                    </tr>
                    <tr>
                        <td>16:00 - 17:00</td>
                        <td>TPA (Anak-anak)</td>
                        <td>Sabtu, Minggu</td>
                        <td>Ustadz Mahmud</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- QR Generator Section -->
        <div id="qr-generator" class="content-section">
            <h2>Generate QR Code untuk Presensi</h2>
            <div class="qr-section">
                <div style="margin-bottom: 20px;">
                    <input type="text" id="nama" placeholder="Nama Jamaah" required>
                    <select id="kegiatan">
                        <option value="">Pilih Kegiatan</option>
                        <option value="Subuh">Sholat Subuh</option>
                        <option value="Dzuhur">Sholat Dzuhur</option>
                        <option value="Ashar">Sholat Ashar</option>
                        <option value="Maghrib">Sholat Maghrib</option>
                        <option value="Isya">Sholat Isya</option>
                        <option value="Pengajian Umum">Pengajian Umum</option>
                        <option value="Pengajian Ibu-ibu">Pengajian Ibu-ibu</option>
                        <option value="TPA">TPA</option>
                    </select>
                </div>
                
                <div class="qr-controls">
                    <button class="btn" onclick="generateQR()">Generate QR Code</button>
                    <button class="btn" onclick="clearQR()">Clear</button>
                </div>
                
                <div id="qrcode"></div>
                <p id="qr-info" style="margin-top: 10px; font-style: italic; color: #666;"></p>
            </div>
        </div>

        <!-- QR Scanner Section -->
        <div id="qr-scanner" class="content-section">
            <h2>Scan QR Code Presensi</h2>
            <div class="qr-section">
                <div class="qr-controls">
                    <button class="btn" onclick="startScanner()" id="start-btn">Mulai Scan</button>
                    <button class="btn" onclick="stopScanner()" id="stop-btn" disabled>Stop Scan</button>
                </div>
                
                <div id="video-container" style="display: none;">
                    <video id="qr-video" playsinline></video>
                </div>
                
                <div id="scanned-qr" style="display: none;">
                    <h3>Hasil Scan:</h3>
                    <p id="scanned-result"></p>
                    <button class="btn" onclick="confirmAttendance()" id="confirm-btn" style="display: none;">Konfirmasi Kehadiran</button>
                </div>
            </div>
        </div>

        <!-- Attendance Section -->
        <div id="attendance" class="content-section">
            <h2>Daftar Kehadiran</h2>
            
            <!-- Manual Submit Form -->
            <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 15px; padding: 20px; margin-bottom: 20px;">
                <h3 style="color: white; margin-bottom: 15px;">üìù Input Manual Kehadiran</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                    <input type="text" id="manual-nama" placeholder="Nama Jamaah" style="max-width: none;">
                    <select id="manual-kegiatan" style="max-width: none;">
                        <option value="">Pilih Kegiatan</option>
                        <option value="Subuh">Sholat Subuh</option>
                        <option value="Dzuhur">Sholat Dzuhur</option>
                        <option value="Ashar">Sholat Ashar</option>
                        <option value="Maghrib">Sholat Maghrib</option>
                        <option value="Isya">Sholat Isya</option>
                        <option value="Pengajian Umum">Pengajian Umum</option>
                        <option value="Pengajian Ibu-ibu">Pengajian Ibu-ibu</option>
                        <option value="TPA">TPA</option>
                    </select>
                    <input type="date" id="manual-tanggal" style="max-width: none;" value="">
                </div>
                <div class="qr-controls">
                    <button class="btn" onclick="submitManualAttendance()">üìù Submit ke Spreadsheet</button>
                    <button class="btn" onclick="clearManualForm()">üîÑ Clear Form</button>
                </div>
            </div>

            <!-- Filter and Controls -->
            <div class="qr-controls">
                <select id="filter-kegiatan" onchange="filterAttendance()">
                    <option value="">Semua Kegiatan</option>
                    <option value="Subuh">Sholat Subuh</option>
                    <option value="Dzuhur">Sholat Dzuhur</option>
                    <option value="Ashar">Sholat Ashar</option>
                    <option value="Maghrib">Sholat Maghrib</option>
                    <option value="Isya">Sholat Isya</option>
                    <option value="Pengajian Umum">Pengajian Umum</option>
                    <option value="Pengajian Ibu-ibu">Pengajian Ibu-ibu</option>
                    <option value="TPA">TPA</option>
                </select>
                <button class="btn" onclick="refreshData()">üîÑ Refresh Data</button>
                <button class="btn" onclick="clearAttendance()">üóëÔ∏è Clear Data</button>
            </div>
            
            <div class="attendance-list" id="attendance-list">
                <p style="text-align: center; color: rgba(255,255,255,0.8);">Belum ada data kehadiran</p>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let qrScanner = null;
        let attendanceData = [];
        let scannedData = null;

        // Google Sheets configuration
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw52-ro6ImS-IFxAO2boCQLE_c_z-X0aHvqymawh3JRbHb-p2lxwZjrFhmdmljuksfF_g/exec'; // Replace with your Apps Script URL
        const SHEET_ID = '1aNj59jiFDyYj-Q05gFB45aJ-w8pNRZ0Eqakw-2k5AuM';

        // Load data from Google Sheets
        async function loadData() {
            try {
                showLoading('Memuat data...');
                const response = await fetch(`${GOOGLE_SCRIPT_URL}?action=read&sheetId=${SHEET_ID}`);
                const data = await response.json();
                
                if (data.success) {
                    attendanceData = data.data || [];
                    displayAttendance();
                }
                hideLoading();
            } catch (error) {
                console.error('Error loading data:', error);
                hideLoading();
                // Fallback to memory storage if Google Sheets fails
            }
        }

        // Save data to Google Sheets
        async function saveData(newRecord) {
            try {
                showLoading('Menyimpan data...');
                
                const response = await fetch(GOOGLE_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'write',
                        sheetId: SHEET_ID,
                        data: newRecord
                    })
                });

                // Add to local array for immediate display
                attendanceData.push(newRecord);
                displayAttendance();
                hideLoading();
                
                return true;
            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
                hideLoading();
                // Fallback to local storage
                attendanceData.push(newRecord);
                displayAttendance();
                return false;
            }
        }

        // Show section
        function showSection(sectionId) {
            // Hide all sections
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.nav-tab');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Add active class to clicked tab
            event.target.classList.add('active');
        }

        // Generate QR Code
        function generateQR() {
            const nama = document.getElementById('nama').value.trim();
            const kegiatan = document.getElementById('kegiatan').value;

            if (!nama || !kegiatan) {
                alert('Mohon isi nama dan pilih kegiatan!');
                return;
            }

            const qrData = {
                nama: nama,
                kegiatan: kegiatan,
                timestamp: new Date().toISOString(),
                id: Date.now().toString()
            };

            // Clear previous QR
            document.getElementById('qrcode').innerHTML = '';

            // Generate QR code
            QRCode.toCanvas(document.getElementById('qrcode'), JSON.stringify(qrData), {
                width: 256,
                height: 256,
                colorDark: '#000000',
                colorLight: '#ffffff',
            }, function (error) {
                if (error) {
                    console.error(error);
                    alert('Error generating QR code');
                } else {
                    document.getElementById('qr-info').textContent = 
                        `QR Code untuk: ${nama} - ${kegiatan}`;
                }
            });
        }

        // Clear QR Code
        function clearQR() {
            document.getElementById('qrcode').innerHTML = '';
            document.getElementById('qr-info').textContent = '';
            document.getElementById('nama').value = '';
            document.getElementById('kegiatan').value = '';
        }

        // Start QR Scanner
        async function startScanner() {
            try {
                const video = document.getElementById('qr-video');
                const videoContainer = document.getElementById('video-container');
                
                qrScanner = new QrScanner(video, result => {
                    try {
                        const data = JSON.parse(result.data);
                        if (data.nama && data.kegiatan) {
                            scannedData = data;
                            document.getElementById('scanned-result').innerHTML = 
                                `<strong>Nama:</strong> ${data.nama}<br>
                                 <strong>Kegiatan:</strong> ${data.kegiatan}<br>
                                 <strong>Waktu Generate:</strong> ${new Date(data.timestamp).toLocaleString('id-ID')}`;
                            document.getElementById('scanned-qr').style.display = 'block';
                            document.getElementById('confirm-btn').style.display = 'inline-block';
                            
                            // Stop scanner after successful scan
                            stopScanner();
                        } else {
                            alert('QR Code tidak valid!');
                        }
                    } catch (e) {
                        alert('QR Code tidak dapat dibaca!');
                    }
                }, {
                    returnDetailedScanResult: true,
                    highlightScanRegion: true,
                    highlightCodeOutline: true,
                });

                await qrScanner.start();
                videoContainer.style.display = 'block';
                document.getElementById('start-btn').disabled = true;
                document.getElementById('stop-btn').disabled = false;
                
            } catch (error) {
                console.error('Error starting scanner:', error);
                alert('Error mengakses kamera. Pastikan browser memiliki izin kamera.');
            }
        }

        // Stop QR Scanner
        function stopScanner() {
            if (qrScanner) {
                qrScanner.stop();
                qrScanner.destroy();
                qrScanner = null;
            }
            document.getElementById('video-container').style.display = 'none';
            document.getElementById('start-btn').disabled = false;
            document.getElementById('stop-btn').disabled = true;
        }

        // Confirm attendance
        async function confirmAttendance() {
            if (!scannedData) {
                alert('Tidak ada data yang di-scan!');
                return;
            }

            // Check if already attended
            const alreadyAttended = attendanceData.some(item => 
                item.nama === scannedData.nama && 
                item.kegiatan === scannedData.kegiatan &&
                new Date(item.attendanceTime).toDateString() === new Date().toDateString()
            );

            if (alreadyAttended) {
                alert('Jamaah sudah tercatat hadir untuk kegiatan ini hari ini!');
                return;
            }

            // Add to attendance
            const attendanceRecord = {
                ...scannedData,
                attendanceTime: new Date().toISOString(),
                tanggal: new Date().toLocaleDateString('id-ID'),
                waktu: new Date().toLocaleTimeString('id-ID'),
                status: 'Hadir'
            };

            const saved = await saveData(attendanceRecord);
            
            if (saved) {
                alert(`Kehadiran ${scannedData.nama} untuk ${scannedData.kegiatan} berhasil dicatat dan disimpan ke Google Sheets!`);
            } else {
                alert(`Kehadiran ${scannedData.nama} untuk ${scannedData.kegiatan} berhasil dicatat! (Tersimpan lokal, koneksi Google Sheets bermasalah)`);
            }

            // Clear scanned data
            document.getElementById('scanned-qr').style.display = 'none';
            document.getElementById('confirm-btn').style.display = 'none';
            scannedData = null;
        }

        // Display attendance
        function displayAttendance() {
            const attendanceList = document.getElementById('attendance-list');
            const filter = document.getElementById('filter-kegiatan').value;

            let filteredData = attendanceData;
            if (filter) {
                filteredData = attendanceData.filter(item => item.kegiatan === filter);
            }

            if (filteredData.length === 0) {
                attendanceList.innerHTML = '<p style="text-align: center; color: rgba(255,255,255,0.8);">Belum ada data kehadiran</p>';
                return;
            }

            // Sort by attendance time (newest first)
            filteredData.sort((a, b) => new Date(b.attendanceTime) - new Date(a.attendanceTime));

            let html = '';
            filteredData.forEach((item, index) => {
                const attendanceTime = new Date(item.attendanceTime);
                html += `
                    <div class="attendance-item">
                        <div>
                            <strong>${item.nama}</strong><br>
                            <small>${item.kegiatan}</small>
                        </div>
                        <div style="text-align: right;">
                            <span style="color: #4CAF50; font-weight: bold;">${item.status}</span><br>
                            <small>${attendanceTime.toLocaleDateString('id-ID')} ${attendanceTime.toLocaleTimeString('id-ID')}</small>
                        </div>
                    </div>
                `;
            });

            attendanceList.innerHTML = html;
        }

        // Submit manual attendance
        async function submitManualAttendance() {
            const nama = document.getElementById('manual-nama').value.trim();
            const kegiatan = document.getElementById('manual-kegiatan').value;
            const tanggal = document.getElementById('manual-tanggal').value;

            if (!nama) {
                alert('Mohon isi nama jamaah!');
                return;
            }

            if (!kegiatan) {
                alert('Mohon pilih kegiatan!');
                return;
            }

            if (!tanggal) {
                alert('Mohon pilih tanggal!');
                return;
            }

            // Check if already attended on selected date
            const selectedDate = new Date(tanggal);
            const alreadyAttended = attendanceData.some(item => 
                item.nama.toLowerCase() === nama.toLowerCase() && 
                item.kegiatan === kegiatan &&
                new Date(item.attendanceTime).toDateString() === selectedDate.toDateString()
            );

            if (alreadyAttended) {
                const confirm = window.confirm(`${nama} sudah tercatat hadir untuk ${kegiatan} pada tanggal ${new Date(tanggal).toLocaleDateString('id-ID')}.\n\nTetap tambahkan data?`);
                if (!confirm) return;
            }

            // Create attendance record
            const attendanceRecord = {
                nama: nama,
                kegiatan: kegiatan,
                attendanceTime: new Date(tanggal + 'T' + new Date().toTimeString().split(' ')[0]).toISOString(),
                tanggal: new Date(tanggal).toLocaleDateString('id-ID'),
                waktu: new Date().toLocaleTimeString('id-ID'),
                status: 'Hadir',
                id: Date.now().toString(),
                timestamp: new Date().toISOString()
            };

            const saved = await saveData(attendanceRecord);
            
            if (saved) {
                alert(`‚úÖ Kehadiran ${nama} untuk ${kegiatan} berhasil disimpan ke Google Sheets!`);
                clearManualForm();
            } else {
                alert(`‚ö†Ô∏è Kehadiran ${nama} untuk ${kegiatan} tersimpan lokal saja. Koneksi Google Sheets bermasalah.`);
            }
        }

        // Clear manual form
        function clearManualForm() {
            document.getElementById('manual-nama').value = '';
            document.getElementById('manual-kegiatan').value = '';
            document.getElementById('manual-tanggal').value = '';
        }

        // Filter attendance
        function filterAttendance() {
            displayAttendance();
        }

        // Clear attendance data
        async function clearAttendance() {
            if (confirm('Apakah Anda yakin ingin menghapus semua data kehadiran?')) {
                try {
                    showLoading('Menghapus data...');
                    
                    const response = await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            action: 'clear',
                            sheetId: SHEET_ID
                        })
                    });

                    attendanceData = [];
                    displayAttendance();
                    hideLoading();
                    alert('Data kehadiran berhasil dihapus dari Google Sheets!');
                } catch (error) {
                    console.error('Error clearing data:', error);
                    attendanceData = [];
                    displayAttendance();
                    hideLoading();
                    alert('Data kehadiran berhasil dihapus! (Local only - koneksi Google Sheets bermasalah)');
                }
            }
        }

        // Show loading indicator
        function showLoading(message = 'Loading...') {
            if (!document.getElementById('loading-indicator')) {
                const loading = document.createElement('div');
                loading.id = 'loading-indicator';
                loading.innerHTML = `
                    <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                         background: rgba(0,0,0,0.5); display: flex; justify-content: center; 
                         align-items: center; z-index: 9999;">
                        <div style="background: white; padding: 20px; border-radius: 10px; 
                             text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
                            <div style="width: 40px; height: 40px; border: 4px solid #f3f3f3; 
                                 border-top: 4px solid #667eea; border-radius: 50%; 
                                 animation: spin 1s linear infinite; margin: 0 auto 10px;"></div>
                            <p>${message}</p>
                        </div>
                    </div>
                    <style>
                        @keyframes spin {
                            0% { transform: rotate(0deg); }
                            100% { transform: rotate(360deg); }
                        }
                    </style>
                `;
                document.body.appendChild(loading);
            }
        }

        // Hide loading indicator
        function hideLoading() {
            const loading = document.getElementById('loading-indicator');
            if (loading) {
                loading.remove();
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default for manual input
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('manual-tanggal').value = today;
            
            loadData();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (qrScanner) {
                qrScanner.stop();
                qrScanner.destroy();
            }
        });
    </script>
</body>
</html>
